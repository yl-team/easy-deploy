!function(e){function r(n){if(o[n])return o[n].exports;var t=o[n]={i:n,l:!1,exports:{}};return e[n].call(t.exports,t,t.exports,r),t.l=!0,t.exports}var o={};r.m=e,r.c=o,r.d=function(e,o,n){r.o(e,o)||Object.defineProperty(e,o,{configurable:!1,enumerable:!0,get:n})},r.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(o,"a",o),o},r.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},r.p="",r(r.s=6)}([function(e,r){e.exports=require("fs")},function(e,r){e.exports=require("extend")},function(e,r){e.exports=require("path")},function(e,r){e.exports=require("ignore")},function(e,r){e.exports=require("node-yaml")},function(e,r){e.exports=require("event-stream")},function(e,r,o){var n=o(7),t=o(8);n.version("0.1.0"),n.command("build-push").arguments("[profile]").option("-C, --context <path>","change the build context").option("-E, --envrionment [env]","set envrionment variables",function(e,r){return r.push(e),r},[]).description("build and push image").alias("bp").action(function(e,r){var o=r.context,n=function(e){var r={};return e.forEach(e=>{var o=e.split("=");1==o.length?r[o[0]]=o[0]:2==o.length&&(r[o[0]]=o[1])}),r}(r.envrionment);o||(o=""),e||(e="alpha"),console.log("context:",o),console.log("profile:",e),n.profile=e;t.readConfig(o);t.buildAndPush(o,n).then((e,r)=>{console.log("push build and image success!"),t.sendRobotMessage(e.imageName+" 创建发布成功 ,耗时"+e.time/1e3+"s")})}),n.parse(process.argv)},function(e,r){e.exports=require("commander")},function(e,r,o){var n=o(9),t=o(10),i=o(0),a=o(2),s=(o(3),o(4),o(1)),c=o(11),l={},u=(e,r)=>{var n=o(14),s=o(0),l=o(15),u=e.context;((e,r)=>{r||(r={});e.configFiles.forEach(o=>{var n=i.readFileSync(a.resolve(e.context,o.in)).toString(),s=t.render(n,r),c=o.out||o.in+".o";console.log(o.in,"=>",c),i.writeFileSync(a.resolve(e.context,c),s)})})(e,r);var g=a.resolve(u,".dockerignore"),d=[".easydeploy.local.yml",".easydeploy.yml",".easydeploy.tar.gz"];e.dockerignore&&e.dockerignore.length&&(d=d.concat(e.dockerignore));var p=c.getIgnoreBase(g,d);return new Promise((e,r)=>{l.pack(u,{ignore:e=>p.ignores(e),map:function(e){return console.log(e.name),e}}).pipe(n.createGzip()).pipe(s.createWriteStream(".easydeploy.tar.gz")).on("close",function(){console.log("archive close"),e()}).on("error",function(){console.log("archive error"),r()})})},g=e=>e.docker?new n(e.docker):new n,d=(e,r)=>{var o=e.imageName;return t.render(o,r)},p=(e,r)=>{var o=d(e,r),n=g(e);return new Promise((e,r)=>{n.buildImage(".easydeploy.tar.gz",{t:o},function(n,t){n?console.error(n):t.on("data",e=>{var o=JSON.parse(e);o.errorDetail?(console.error(o.errorDetail),r(o.errorDetail)):console.log(o.stream.trim())}).on("error",e=>{console.log("error"),r("error build image")}).on("end",r=>{console.log("build image end ",r),e(o)})})})},f=(e,r)=>{var o=d(e,r),n=g(e).getImage(o),t=e.registryAuth;return new Promise((e,r)=>{n.push({authconfig:t},(o,n)=>{console.log(o),n.on("data",e=>{var o=JSON.parse(e);if(o.errorDetail)console.error(o.errorDetail),r(o.errorDetail);else{var n=null;o.status?(n=o.status,o.id&&(n+=" "+o.id)):o.aux&&(n="Tag:"+o.aux.Tag+" Digest:"+o.aux.Digest+" Size:"+o.aux.Size),console.log(n)}}).on("end",e).on("error",r)})})};e.exports={readConfig:e=>{var r=[a.resolve(e,".easydeploy.yml"),a.resolve(e,".easydeploy.local.yml")],o=c.readYamlConfig(r);return o.context=e,s(l,o),l},createArchive:u,buildImage:p,pushImage:f,buildAndPush:(e,r)=>{var o=(new Date).getTime();return u(l,r).then(()=>(console.log("archive finished!"),p(l,r).then(e=>f(l,r).then(()=>{var r=(new Date).getTime();return{imageName:e,time:r-o}})).catch(e=>{console.error(e)}))).catch(e=>{console.error(e)})},sendRobotMessage:e=>{let r={msgtype:"text",text:{content:e}};return c.getChatBot(l).send(r)}}},function(e,r){e.exports=require("dockerode")},function(e,r){e.exports=require("mustache")},function(e,r,o){var n=o(0),t=(o(2),o(4)),i=o(1),a=o(3),s=o(12),i=o(1),c=o(13);e.exports={readYamlConfig:e=>{var r={};return e.forEach(e=>{if(n.existsSync(e)){var o=t.parse(n.readFileSync(e));i(r,o)}}),r},getIgnoreFilter:(e,r)=>{var o=[];return n.existsSync(e)&&(console.log("exists dockerignore file"),o.push(s.sync(e))),r&&o.push(s.compile(r)),e=>{for(var r=0;r<o.length;r++)if(o[r](e))return!0;return!1}},getIgnoreBase:(e,r)=>{var o=a();return n.existsSync(e)&&o.add(n.readFileSync(e).toString()),r&&o.add(r),o},getChatBot:e=>{return new c({webhook:e.dingtalWebhook})},formateDate2YMD:e=>{var r=e.getUTCMonth()+1,o=e.getUTCDate(),n=e.getUTCFullYear();return newdate=""+n+r+o,newdate}}},function(e,r){e.exports=require("ignore-file")},function(e,r){e.exports=require("dingtalk-robot-sender")},function(e,r){e.exports=require("zlib")},function(e,r){e.exports=require("tar-fs")}]);